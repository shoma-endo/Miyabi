# ğŸ•·ï¸ Water Spider Pattern - å®Œå…¨ã‚¬ã‚¤ãƒ‰

**ãƒˆãƒ¨ã‚¿ç”Ÿç”£æ–¹å¼ã®ã€ŒWater Spider (è³‡æè£œå……ä¿‚)ã€ã‚’å¿œç”¨ã—ãŸã€æ°¸ç¶šçš„è‡ªå‹•ç¶™ç¶šã‚·ã‚¹ãƒ†ãƒ **

## ğŸ“‹ æ¦‚è¦

### ç¾åœ¨ã®æ±ºå®šçš„å¼±ç‚¹

âŒ **Claude Codeã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåœæ­¢ã—ãŸæ™‚ã€äººé–“ãŒã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™å¿…è¦ãŒã‚ã‚‹**
- è‡ªå‹•åŒ–ã®ç¶™ç¶šæ€§ãŒé€”åˆ‡ã‚Œã‚‹
- å®Œå…¨è‡ªå¾‹å®Ÿè¡ŒãŒã§ããªã„
- ä¸¦è¡Œå®Ÿè¡ŒãŒåˆ¶é™ã•ã‚Œã‚‹

### Water Spider Pattern ã«ã‚ˆã‚‹è§£æ±º

âœ… **å®Œå…¨è‡ªå¾‹å®Ÿè¡Œ**
- äººé–“ã®ä»‹å…¥ãªã—ã§æ°¸ç¶šçš„ã«å®Ÿè¡Œ
- ã€Œæ¬¡ã¸ã€ã‚’æŠ¼ã™å¿…è¦ãªã—
- ã‚»ãƒƒã‚·ãƒ§ãƒ³åœæ­¢ã‚’è‡ªå‹•æ¤œçŸ¥ â†’ å³åº§ã«ç¶™ç¶š

âœ… **çœŸã®ä¸¦è¡Œå®Ÿè¡Œ**
- è¤‡æ•°Worktreeã§åŒæ™‚ã«ä½œæ¥­
- ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã®ç‹¬ç«‹æ€§ç¶­æŒ
- Just-In-Timeè³‡æè£œå……

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CoordinatorAgent (Orchestrator)       â”‚
â”‚       - å…¨ä½“ç›£è¦–                             â”‚
â”‚       - ã‚¿ã‚¹ã‚¯åˆ†è§£                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    WaterSpiderAgent (Auto-Continue)         â”‚
â”‚    - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦– (5ç§’é–“éš”)                â”‚
â”‚    - åœæ­¢æ¤œçŸ¥ â†’ è‡ªå‹•ç¶™ç¶š                     â”‚
â”‚    - Webhooké€šä¿¡                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚           â”‚           â”‚           â”‚
     â–¼           â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tmux    â”‚ â”‚ Tmux    â”‚ â”‚ Tmux    â”‚ â”‚ Tmux    â”‚
â”‚ Session â”‚ â”‚ Session â”‚ â”‚ Session â”‚ â”‚ Session â”‚
â”‚ #1      â”‚ â”‚ #2      â”‚ â”‚ #3      â”‚ â”‚ #4      â”‚
â”‚         â”‚ â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
â”‚ Claude  â”‚ â”‚ Claude  â”‚ â”‚ Claude  â”‚ â”‚ Claude  â”‚
â”‚ Code    â”‚ â”‚ Code    â”‚ â”‚ Code    â”‚ â”‚ Code    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Webhook Server (localhost:3002)          â”‚
â”‚    - POST /api/session/status               â”‚
â”‚    - POST /api/session/:id/continue         â”‚
â”‚    - GET  /api/sessions                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ä½¿ã„æ–¹

### 1. åŸºæœ¬çš„ãªèµ·å‹•

```bash
# Water Spiderèµ·å‹• (å…¨è‡ªå‹•)
npm run water-spider:start
```

ã“ã‚Œã§ä»¥ä¸‹ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™:
1. Webhookã‚µãƒ¼ãƒãƒ¼èµ·å‹• (port 3002)
2. å…¨Worktreeã«å¯¾ã—ã¦Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
3. Water Spiderç›£è¦–é–‹å§‹

### 2. å€‹åˆ¥æ“ä½œ

#### Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```bash
# å…¨Worktreeã«å¯¾ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
npm run water-spider:create-sessions

# ã¾ãŸã¯
npm run tmux:create

# å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
npm run tmux:list

# å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
npm run tmux:kill
```

#### Webhookã‚µãƒ¼ãƒãƒ¼ã®ã¿èµ·å‹•

```bash
# ãƒ‡ãƒãƒƒã‚°ç”¨: Webhookã‚µãƒ¼ãƒãƒ¼ã®ã¿èµ·å‹•
npm run water-spider:webhook
```

#### ã‚»ãƒƒã‚·ãƒ§ãƒ³ç›£è¦–ã®ã¿

```bash
# Webhookã‚µãƒ¼ãƒãƒ¼ãŒæ—¢ã«èµ·å‹•ã—ã¦ã„ã‚‹å ´åˆ
npm run water-spider:start
```

### 3. Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®æ¥ç¶š

```bash
# ç‰¹å®šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶š
tsx scripts/tmux/tmux-manager.ts attach miyabi-issue-101-phase3-review

# Detach: Ctrl+B â†’ D
```

## âš™ï¸ è¨­å®š

### ç›£è¦–è¨­å®š (scripts/water-spider-main.ts)

```typescript
const config: WaterSpiderConfig = {
  monitorInterval: 5000,    // ç›£è¦–é–“éš”: 5ç§’
  maxIdleTime: 30000,       // æœ€å¤§ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚é–“: 30ç§’
  autoRestart: true,        // è‡ªå‹•å†èµ·å‹•: æœ‰åŠ¹
  webhookUrl: 'http://localhost:3002',
};
```

### Webhookè¨­å®š

- **Port**: 3002 (å¤‰æ›´å¯èƒ½)
- **Endpoints**:
  - `POST /api/session/status` - ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹å—ä¿¡
  - `POST /api/session/:id/continue` - ç¶™ç¶šé€šçŸ¥
  - `GET /api/sessions` - å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—
  - `GET /health` - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

## ğŸ“Š ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

### ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª

```bash
# ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
open http://localhost:3002/api/sessions

# ã¾ãŸã¯ curl
curl http://localhost:3002/api/sessions | jq
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹**:

```json
{
  "timestamp": "2025-10-13T06:30:00.000Z",
  "total": 4,
  "sessions": [
    {
      "sessionId": "issue-101-phase3-review",
      "status": "running",
      "lastActivity": 1728806400000,
      "idleTime": 0,
      "needsContinue": false,
      "continueCount": 3
    },
    {
      "sessionId": "issue-102-phase4-coverage",
      "status": "idle",
      "lastActivity": 1728806370000,
      "idleTime": 30000,
      "needsContinue": true,
      "continueCount": 5
    }
  ]
}
```

## ğŸ”„ å‹•ä½œãƒ•ãƒ­ãƒ¼

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³èµ·å‹•

```
npm run water-spider:start
  â†“
Webhookã‚µãƒ¼ãƒãƒ¼èµ·å‹• (localhost:3002)
  â†“
Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ (.worktrees/* â†’ miyabi-*)
  â†“
å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§Claude Codeèµ·å‹•
  â†“
Water Spiderç›£è¦–é–‹å§‹
```

### 2. ç›£è¦–ãƒ«ãƒ¼ãƒ— (5ç§’ã”ã¨)

```
ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  â†“
Tmux paneã‚­ãƒ£ãƒ—ãƒãƒ£
  â†“
ã‚¢ã‚¤ãƒ‰ãƒ«æ¤œå‡º (ã€Œç¶šã‘ã¾ã™ã‹ã€ã€ŒContinue?ã€ç­‰)
  â†“
YES â†’ ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚é–“ > 30ç§’?
  â†“
YES â†’ ã€Œç¶šã‘ã¦ãã ã•ã„ã€é€ä¿¡
  â†“
Webhooké€šçŸ¥
  â†“
æ¬¡ã®ç›£è¦–ã¸ (5ç§’å¾Œ)
```

### 3. è‡ªå‹•ç¶™ç¶š

```
åœæ­¢æ¤œçŸ¥
  â†“
tmux send-keys "ç¶šã‘ã¦ãã ã•ã„" Enter
  â†“
ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹
  â†“
ç¶™ç¶šã‚«ã‚¦ãƒ³ãƒˆ +1
  â†“
Webhooké€šçŸ¥
```

## ğŸ› ï¸ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä½œæˆã•ã‚Œãªã„

```bash
# Tmuxã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
which tmux

# macOS
brew install tmux

# Ubuntu
sudo apt-get install tmux
```

### ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåœæ­¢ã—ç¶šã‘ã‚‹

```bash
# ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
npm run tmux:list

# ç‰¹å®šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«æ¥ç¶šã—ã¦ç¢ºèª
tsx scripts/tmux/tmux-manager.ts attach miyabi-issue-101

# ãƒ­ã‚°ç¢ºèª
tail -f logs/*.log
```

### Webhookã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„

```bash
# ãƒãƒ¼ãƒˆ3002ãŒä½¿ç”¨ä¸­ã‹ç¢ºèª
lsof -i:3002

# ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†
kill -9 <PID>

# Webhookã‚µãƒ¼ãƒãƒ¼ã®ã¿èµ·å‹•ã—ã¦ãƒ†ã‚¹ãƒˆ
npm run webhook:server
```

### è‡ªå‹•ç¶™ç¶šãŒå‹•ä½œã—ãªã„

```bash
# Hookã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ¨©é™ç¢ºèª
ls -la .claude/hooks/session-continue.sh

# æ‰‹å‹•ãƒ†ã‚¹ãƒˆ
./.claude/hooks/session-continue.sh miyabi-issue-101-phase3-review

# ã‚¢ã‚¤ãƒ‰ãƒ«æ¤œå‡ºãƒ†ã‚¹ãƒˆ
tmux capture-pane -t miyabi-issue-101-phase3-review -p | grep "ç¶šã‘ã¾ã™ã‹"
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡

- **CPU**: ä½è² è· (ç›£è¦–ãƒ«ãƒ¼ãƒ—ã®ã¿)
- **ãƒ¡ãƒ¢ãƒª**: å„Tmuxã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã« ~50MB
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**: ãƒ­ãƒ¼ã‚«ãƒ«é€šä¿¡ã®ã¿ (Webhook)

### ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

- **æ¨å¥¨**: 4-8ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸¦è¡Œ
- **æœ€å¤§**: åˆ¶é™ãªã— (ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ä¾å­˜)

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### 1. å®Œå…¨è‡ªå¾‹å®Ÿè¡Œ âœ…

- äººé–“ã®ä»‹å…¥ãªã—
- 24/7ç¨¼åƒå¯èƒ½
- è‡ªå‹•å¾©å¸°

### 2. é–‹ç™ºåŠ¹ç‡å‘ä¸Š âœ…

- ä¸¦è¡Œå®Ÿè¡Œã«ã‚ˆã‚‹é«˜é€ŸåŒ–
- å¾…ã¡æ™‚é–“ã‚¼ãƒ­
- ãƒªã‚½ãƒ¼ã‚¹æœ€é©æ´»ç”¨

### 3. ãƒˆãƒ¨ã‚¿ç”Ÿç”£æ–¹å¼ã®å®Ÿç¾ âœ…

- Just-In-Timeè£œå……
- ãƒ ãƒ€ã®æ’é™¤ (å¾…ã¡æ™‚é–“)
- ç¶™ç¶šçš„ãƒ•ãƒ­ãƒ¼

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [OpenAI Dev Day Integration](../CLAUDE.md#git-worktreeä¸¦åˆ—å®Ÿè¡Œã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [CoordinatorAgent](../.claude/agents/specs/coding/coordinator-agent.md)
- [Tmux Best Practices](https://github.com/tmux/tmux/wiki)

## ğŸ“ å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«

### Core Components

- `agents/water-spider/water-spider-agent.ts` - Water Spideræœ¬ä½“
- `agents/water-spider/session-manager.ts` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- `agents/water-spider/webhook-client.ts` - Webhooké€šä¿¡

### Infrastructure

- `scripts/tmux/tmux-manager.ts` - Tmuxåˆ¶å¾¡
- `scripts/webhook/webhook-server.ts` - Webhookã‚µãƒ¼ãƒãƒ¼
- `.claude/hooks/session-continue.sh` - è‡ªå‹•ç¶™ç¶šHook

### Entry Point

- `scripts/water-spider-main.ts` - ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ

---

ğŸ•·ï¸ **Water Spider Pattern** - ãƒ©ã‚¤ãƒ³ã‚’æ­¢ã‚ãªã„ã€æ°¸ç¶šçš„è‡ªå‹•ç¶™ç¶šã‚·ã‚¹ãƒ†ãƒ 

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
